#!/bin/sh

# River WM configuration
# Arch Linux + NVIDIA hybrid graphics
# No bar - minimal, terminal-first

# === Gruvbox Dark Medium Colors ===
# base00: 282828 (bg)      base08: fb4934 (red)
# base01: 3c3836           base09: fe8019 (orange)
# base02: 504945           base0A: fabd2f (yellow)
# base03: 665c54           base0B: b8bb26 (green)
# base04: bdae93           base0C: 8ec07c (cyan)
# base05: d5c4a1 (fg)      base0D: 83a598 (blue)
# base06: ebdbb2           base0E: d3869b (magenta)
# base07: fbf1c7           base0F: d65d0e (brown)

# === Environment Variables ===
export XDG_CURRENT_DESKTOP=river
export XDG_SESSION_TYPE=wayland
export XDG_SESSION_DESKTOP=river

# Wayland compatibility
export MOZ_ENABLE_WAYLAND=1
export QT_QPA_PLATFORM="wayland;xcb"
export QT_WAYLAND_DISABLE_WINDOWDECORATION=1
export QT_AUTO_SCREEN_SCALE_FACTOR=1
export GDK_BACKEND="wayland,x11"
export SDL_VIDEODRIVER=wayland
export CLUTTER_BACKEND=wayland

# Electron apps (Teams, VS Code)
export ELECTRON_OZONE_PLATFORM_HINT=wayland

# Cursor
export XCURSOR_SIZE=24
export XCURSOR_THEME=Adwaita

# NVIDIA hybrid graphics
# Comment these out if using integrated mode for battery
export WLR_NO_HARDWARE_CURSORS=1
export LIBVA_DRIVER_NAME=nvidia
export GBM_BACKEND=nvidia-drm
export __GLX_VENDOR_LIBRARY_NAME=nvidia
export WLR_DRM_DEVICES=/dev/dri/card1:/dev/dri/card0

# === Mod Key ===
mod="Super"

# === Basic Settings ===
riverctl border-width 2
riverctl set-cursor-warp on-focus-change

# === Border Colors (Gruvbox) ===
riverctl border-color-focused 0x83a598
riverctl border-color-unfocused 0x504945
riverctl border-color-urgent 0xfb4934

# === Input Configuration ===
# Flat acceleration for mice (MX Master, gaming mice)
riverctl input "*" accel-profile flat
riverctl input "*" tap enabled
riverctl input "*" natural-scroll enabled
riverctl input "type:keyboard" repeat-delay 250
riverctl input "type:keyboard" repeat-rate 30

# === Window Focus (vim-style) ===
riverctl map normal $mod H focus-view left
riverctl map normal $mod J focus-view down
riverctl map normal $mod K focus-view up
riverctl map normal $mod L focus-view right

# === Window Swap ===
riverctl map normal $mod+Shift H swap left
riverctl map normal $mod+Shift J swap down
riverctl map normal $mod+Shift K swap up
riverctl map normal $mod+Shift L swap right

# === Window Actions ===
riverctl map normal $mod Q close
riverctl map normal $mod F toggle-fullscreen
riverctl map normal $mod Space toggle-float

# === Layout Control (wideriver) ===
riverctl map normal $mod+Control H send-layout-cmd wideriver "--ratio -0.05"
riverctl map normal $mod+Control L send-layout-cmd wideriver "--ratio +0.05"
riverctl map normal $mod M send-layout-cmd wideriver "--layout monocle"
riverctl map normal $mod T send-layout-cmd wideriver "--layout left"
riverctl map normal $mod Tab send-layout-cmd wideriver "--layout-toggle"

# === Tags (Workspaces 1-9) ===
for i in $(seq 1 9); do
    tags=$((1 << ($i - 1)))
    riverctl map normal $mod $i set-focused-tags $tags
    riverctl map normal $mod+Shift $i set-view-tags $tags
    riverctl map normal $mod+Control $i toggle-focused-tags $tags
    riverctl map normal $mod+Control+Shift $i toggle-view-tags $tags
done

# All tags (tag 0 = all)
all_tags=$(((1 << 9) - 1))
riverctl map normal $mod 0 set-focused-tags $all_tags
riverctl map normal $mod+Shift 0 set-view-tags $all_tags

# === Scratchpad (tag 21) ===
scratch_tag=$((1 << 20))
riverctl map normal $mod P toggle-focused-tags ${scratch_tag}
riverctl map normal $mod+Shift P set-view-tags ${scratch_tag}
all_but_scratch_tag=$(( ((1 << 32) - 1) ^ $scratch_tag ))
riverctl spawn-tagmask ${all_but_scratch_tag}

# === App Launchers ===
riverctl map normal $mod Return spawn foot
riverctl map normal $mod A spawn fuzzel
riverctl map normal $mod D spawn fuzzel
riverctl map normal $mod B spawn firefox
riverctl map normal $mod E spawn "foot -e yazi"

# === Screenshots ===
riverctl map normal None Print spawn screenshot-area
riverctl map normal $mod+Shift S spawn screenshot-area
riverctl map normal Control Print spawn screenshot-screen
riverctl map normal Shift Print spawn screenshot-save

# === Screen Recording ===
riverctl map normal $mod R spawn screenrecord-area
riverctl map normal $mod+Control R spawn screenrecord-screen
riverctl map normal $mod+Shift R spawn screenrecord-save

# === Clipboard History ===
riverctl map normal $mod V spawn 'cliphist list | fuzzel --dmenu | cliphist decode | wl-copy'

# === Screen Lock ===
riverctl map normal $mod Escape spawn swaylock

# === Power Menu ===
riverctl map normal $mod+Shift E spawn wlogout

# === System Status (no bar, so use notification) ===
riverctl map normal $mod S spawn system-status

# === Floating TUI Apps ===
riverctl map normal $mod+Shift B spawn "foot --title=btop -e btop"
riverctl map normal $mod+Shift T spawn "foot --title=bluetuith -e bluetuith"
riverctl map normal $mod+Shift I spawn "foot --title=impala -e impala"
riverctl map normal $mod+Shift N spawn nvidia-toggle
riverctl map normal $mod+Shift A spawn "foot --title=pulsemixer -e pulsemixer"

# === Display Management ===
riverctl map normal $mod+Control D spawn wdisplays
riverctl map normal $mod+Control M spawn "kanshictl reload"

# === Notification Control ===
riverctl map normal $mod N spawn "makoctl dismiss"
riverctl map normal $mod+Control N spawn "makoctl dismiss --all"

# === Keybind Cheatsheet ===
riverctl map normal $mod Slash spawn river-keybinds

# === Media Keys ===
riverctl map normal None XF86AudioRaiseVolume spawn 'wpctl set-volume @DEFAULT_AUDIO_SINK@ 5%+'
riverctl map normal None XF86AudioLowerVolume spawn 'wpctl set-volume @DEFAULT_AUDIO_SINK@ 5%-'
riverctl map normal None XF86AudioMute spawn 'wpctl set-mute @DEFAULT_AUDIO_SINK@ toggle'
riverctl map normal None XF86AudioMicMute spawn 'wpctl set-mute @DEFAULT_AUDIO_SOURCE@ toggle'
riverctl map normal None XF86AudioPlay spawn 'playerctl play-pause'
riverctl map normal None XF86AudioPause spawn 'playerctl play-pause'
riverctl map normal None XF86AudioNext spawn 'playerctl next'
riverctl map normal None XF86AudioPrev spawn 'playerctl previous'
riverctl map normal None XF86MonBrightnessUp spawn 'brightnessctl set +5%'
riverctl map normal None XF86MonBrightnessDown spawn 'brightnessctl set 5%-'

# === Mouse Bindings ===
riverctl map-pointer normal $mod BTN_LEFT move-view
riverctl map-pointer normal $mod BTN_RIGHT resize-view
riverctl map-pointer normal $mod BTN_MIDDLE toggle-float

# === Focus follows mouse ===
riverctl focus-follows-cursor normal

# === Window Rules ===
riverctl rule-add -app-id 'btop' float
riverctl rule-add -app-id 'bluetuith' float
riverctl rule-add -app-id 'impala' float
riverctl rule-add -app-id 'pulsemixer' float
riverctl rule-add -app-id 'pavucontrol' float
riverctl rule-add -app-id 'nm-connection-editor' float
riverctl rule-add -app-id '.blueman-*' float
riverctl rule-add -app-id 'org.gnome.Calculator' float
riverctl rule-add -app-id 'wdisplays' float
riverctl rule-add -app-id 'solaar' float

# === Autostart ===

# XDG Portal for screenshare (CRITICAL for Teams/Firefox)
riverctl spawn "dbus-update-activation-environment --systemd WAYLAND_DISPLAY XDG_CURRENT_DESKTOP=river"
riverctl spawn "/usr/lib/xdg-desktop-portal-wlr &"
riverctl spawn "/usr/lib/xdg-desktop-portal &"

# Layout generator (wideriver - dwm/xmonad style)
riverctl spawn "wideriver --layout left --stack dwindle --count-master 1 --ratio-master 0.55 --border-width 2 --border-width-monocle 0 --inner-gap 4 --outer-gap 4"

# Notifications
riverctl spawn mako

# Clipboard watchers
riverctl spawn "wl-paste --type text --watch cliphist store"
riverctl spawn "wl-paste --type image --watch cliphist store"

# Idle lock (lock after 5min, screen off after 10min)
riverctl spawn "swayidle -w timeout 300 'swaylock -f' timeout 600 'wlr-randr --output eDP-1 --off' resume 'wlr-randr --output eDP-1 --on' before-sleep 'swaylock -f'"

# Night light
riverctl spawn gammastep

# Polkit agent (for sudo GUI prompts)
riverctl spawn /usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1

# Auto display management
riverctl spawn kanshi

# === Default layout generator ===
riverctl default-layout wideriver
