<?xml version="1.0" encoding="UTF-8"?>
<project_specification>
  <project_name>NixOS System Configuration</project_name>

  <overview>
    A comprehensive, production-grade NixOS system configuration designed for a software engineering workstation. This flake-based configuration provides a fully declarative, reproducible desktop environment built on the River Wayland compositor with extensive security hardening, modern development tooling, and seamless multi-monitor support. The configuration emphasizes stability through immutable infrastructure principles while providing a professional software development environment with support for multiple programming languages, cloud platforms, and AI-assisted development tools. Key design goals include system reproducibility, security by default, aesthetic consistency via unified theming (Ayu Dark), and an optimized workflow for professional software development.
  </overview>

  <technology_stack>
    <technology>NixOS (nixos-unstable)</technology>
    <technology>Nix Flakes</technology>
    <technology>Home Manager</technology>
    <technology>River Wayland Compositor</technology>
    <technology>Wideriver (layout generator)</technology>
    <technology>Ghostty Terminal</technology>
    <technology>Neovim (nvf framework)</technology>
    <technology>Fish Shell with Starship Prompt</technology>
    <technology>Stylix (unified theming)</technology>
    <technology>Agenix (secrets management)</technology>
    <technology>PipeWire (audio)</technology>
    <technology>systemd-boot</technology>
    <technology>iwd (wireless)</technology>
    <technology>Kanshi (display management)</technology>
    <technology>AppArmor (MAC)</technology>
    <technology>auditd (security logging)</technology>
    <technology>treefmt-nix (code formatting)</technology>
    <technology>pre-commit-hooks</technology>
    <technology>Git with Delta</technology>
    <technology>Direnv with nix-direnv</technology>
    <technology>Docker/Docker Compose</technology>
    <technology>Kubernetes (kubectl, k9s, Helm)</technology>
    <technology>AWS CLI v2</technology>
    <technology>Google Cloud SDK</technology>
    <technology>Azure CLI</technology>
    <technology>OpenTofu (Terraform)</technology>
    <technology>Node.js 22 / Bun</technology>
    <technology>Python 3.12</technology>
    <technology>Rust</technology>
    <technology>Go</technology>
    <technology>PostgreSQL/MariaDB/Redis/MongoDB clients</technology>
    <technology>LSP servers (TypeScript, Python, Lua, Nix, Terraform, Rust, Go)</technology>
    <technology>Telescope (fuzzy finder)</technology>
    <technology>blink-cmp (autocomplete)</technology>
    <technology>Harpoon (quick file navigation)</technology>
    <technology>Lazygit</technology>
    <technology>Claude Code / OpenCode (AI coding assistants)</technology>
    <technology>Zen Browser / Firefox / Chrome</technology>
    <technology>JetBrains DataGrip</technology>
    <technology>Zed Editor</technology>
    <technology>Teams for Linux</technology>
    <technology>Zoom</technology>
    <technology>LibreOffice</technology>
  </technology_stack>

  <core_capabilities>
    <capability>Fully declarative, reproducible system configuration via Nix Flakes</capability>
    <capability>River Wayland compositor with vim-style keybindings and wideriver tiling</capability>
    <capability>Comprehensive security hardening (kernel, network, AppArmor, auditd, PAM)</capability>
    <capability>Unified Ayu Dark theme across all applications via Stylix</capability>
    <capability>Multi-monitor display management with automatic workspace setup</capability>
    <capability>Modern development environment with LSP support for 8+ languages</capability>
    <capability>AI-assisted coding with Claude Code and OpenCode integration</capability>
    <capability>Hybrid GPU setup (AMD primary, NVIDIA PRIME offload)</capability>
    <capability>PipeWire audio with high-quality Bluetooth codec support</capability>
    <capability>Secrets management with age encryption (agenix)</capability>
    <capability>Fast boot with systemd-boot and systemd-initrd</capability>
    <capability>Optimized Nix builds with parallel jobs and binary caches</capability>
    <capability>Fish shell with zoxide, atuin, and modern CLI tooling</capability>
    <capability>Clipboard history management with cliphist</capability>
    <capability>Screenshot and screen recording capabilities</capability>
    <capability>Blue light filter (gammastep) with automatic scheduling</capability>
    <capability>Docker and Kubernetes development support</capability>
    <capability>Multi-cloud CLI support (AWS, GCP, Azure)</capability>
    <capability>Pre-commit hooks and code formatting (treefmt)</capability>
  </core_capabilities>

  <implemented_features>
    <feature>
      <name>River Wayland Compositor</name>
      <description>Complete River WM configuration with vim-style keybindings, workspace tags (1-9), scratchpad support, multi-monitor navigation, floating window rules, and wideriver layout generator integration. Includes keybindings for window focus/swap, fullscreen, floating toggle, and app launchers.</description>
      <file_locations>
        <location>modules/home/river.nix</location>
      </file_locations>
    </feature>
    <feature>
      <name>Security Hardening Module</name>
      <description>Comprehensive kernel hardening (kptr_restrict, dmesg_restrict, BPF restrictions, ptrace limits), network hardening (reverse path filtering, ICMP redirect blocking), sudo restrictions (wheel-only, password timeout, env_reset), AppArmor MAC, auditd logging with execve tracking, and PAM file descriptor limits.</description>
      <file_locations>
        <location>modules/system/hardening.nix</location>
      </file_locations>
    </feature>
    <feature>
      <name>Neovim IDE Configuration</name>
      <description>Full Neovim configuration via nvf framework with LSP support for TypeScript, Python, Lua, Nix, Terraform, Rust, Go, and Markdown. Includes Telescope fuzzy finding, blink-cmp autocomplete, Harpoon quick navigation, which-key hints, gitsigns, oil file browser, lazygit integration, and OpenCode AI assistant. Comprehensive markdown editing with render-markdown, vim-markdown, and live preview.</description>
      <file_locations>
        <location>modules/home/nvf.nix</location>
      </file_locations>
    </feature>
    <feature>
      <name>Unified Theming (Stylix)</name>
      <description>System-wide Ayu Dark theme applied consistently across all applications including Neovim, Fish, GTK, Firefox, Ghostty terminal, fuzzel launcher, fnott notifications, waylock screen locker, and wlogout power menu. Uses base16 color scheme propagation.</description>
      <file_locations>
        <location>modules/home/theme.nix</location>
      </file_locations>
    </feature>
    <feature>
      <name>Modern Shell Environment</name>
      <description>Fish shell with vi keybindings, Starship prompt with git integration, zoxide smart cd, atuin database-backed history, and direnv with nix-direnv for automatic project environment switching. Includes shell abbreviations for git and modern CLI tool replacements (eza, bat, etc.).</description>
      <file_locations>
        <location>modules/home/shell.nix</location>
      </file_locations>
    </feature>
    <feature>
      <name>Multi-Monitor Display Management</name>
      <description>Kanshi-based automatic display profile switching supporting laptop-only, docked (ultrawide), dual-monitor (portrait + ultrawide), and presentation modes. Each profile triggers workspace setup scripts that launch appropriate applications on designated tags.</description>
      <file_locations>
        <location>modules/home/services.nix</location>
      </file_locations>
    </feature>
    <feature>
      <name>Audio Configuration</name>
      <description>PipeWire audio server with ALSA, PulseAudio, and JACK support. WirePlumber configuration enables high-quality Bluetooth codecs (SBC-XQ, mSBC, AAC, aptX, LDAC) with automatic profile switching between A2DP and headset modes.</description>
      <file_locations>
        <location>modules/system/audio.nix</location>
      </file_locations>
    </feature>
    <feature>
      <name>Hybrid GPU Support</name>
      <description>PRIME offload configuration with AMD Phoenix1 as primary display GPU and NVIDIA RTX 2000 Ada for on-demand compute via nvidia-offload command. Includes VA-API hardware acceleration for video encoding/decoding.</description>
      <file_locations>
        <location>modules/system/graphics.nix</location>
      </file_locations>
    </feature>
    <feature>
      <name>Secrets Management</name>
      <description>Agenix integration for age-encrypted secrets decrypted at system activation. Currently manages AWS credentials with proper file permissions (0400) decrypted directly to ~/.aws/credentials.</description>
      <file_locations>
        <location>secrets/default.nix</location>
        <location>secrets/secrets.nix</location>
      </file_locations>
    </feature>
    <feature>
      <name>Boot Optimization</name>
      <description>systemd-boot with configuration limits, disabled editor for security, systemd-based initrd for faster boot, quiet boot parameters, haveged for entropy generation, and HiDPI console with Ayu Dark colors.</description>
      <file_locations>
        <location>modules/system/bootloader.nix</location>
      </file_locations>
    </feature>
    <feature>
      <name>Networking Configuration</name>
      <description>iwd-based wireless management replacing NetworkManager, firewall with open development ports (SSH, HTTP/S, Node.js, Vite, Django, etc.), IPv6 support, and route priority configuration.</description>
      <file_locations>
        <location>modules/system/networking.nix</location>
      </file_locations>
    </feature>
    <feature>
      <name>Ghostty Terminal</name>
      <description>Modern GPU-accelerated terminal with transparency, no window decorations, JetBrainsMono Nerd Font, clipboard integration, and million-line scrollback buffer.</description>
      <file_locations>
        <location>modules/home/terminal.nix</location>
      </file_locations>
    </feature>
    <feature>
      <name>Development Tooling</name>
      <description>Comprehensive development environment including Git with Delta diff viewer, Docker Compose, Kubernetes tools (kubectl, k9s, Helm), database clients (PostgreSQL, MariaDB, Redis, MongoDB), cloud CLIs (AWS, GCP, Azure), formatters/linters (Prettier, Black, Ruff, Shellcheck), and debuggers (GDB, LLDB).</description>
      <file_locations>
        <location>modules/home/default.nix</location>
      </file_locations>
    </feature>
    <feature>
      <name>Workspace Automation</name>
      <description>Automatic workspace setup scripts for different monitor configurations that launch development applications (Neovim, Claude Code, Zen Browser, terminals, DataGrip, Teams) on designated River tags with proper window placement.</description>
      <file_locations>
        <location>modules/home/default.nix</location>
      </file_locations>
    </feature>
    <feature>
      <name>Screenshot and Recording</name>
      <description>grim/slurp-based screenshot capture (area, screen, save to file) and wf-recorder screen recording with clipboard integration and keyboard shortcuts.</description>
      <file_locations>
        <location>modules/home/default.nix</location>
        <location>modules/home/river.nix</location>
      </file_locations>
    </feature>
    <feature>
      <name>Blue Light Filter</name>
      <description>Gammastep service with location-based day/night temperature adjustment (6500K day, 3500K night), Wayland support, and automatic fade transitions.</description>
      <file_locations>
        <location>modules/home/services.nix</location>
      </file_locations>
    </feature>
    <feature>
      <name>Code Formatting Pipeline</name>
      <description>treefmt-nix integration with nixfmt, Prettier, and shfmt formatters, plus pre-commit hooks with nixfmt and shellcheck.</description>
      <file_locations>
        <location>flake.nix</location>
        <location>treefmt.nix</location>
      </file_locations>
    </feature>
    <feature>
      <name>GUI File Manager</name>
      <description>Add Thunar or Nautilus as graphical file manager with Ayu Dark theming. Includes thumbnail generation, archive support, trash integration, and network share mounting via River keybinding.</description>
    </feature>
    <feature>
      <name>PDF Viewer with Annotations</name>
      <description>Add zathura or evince with annotation support for highlighting, notes, and form filling. Includes vim keybindings, bookmark management, and print support with Ayu Dark theme.</description>
    </feature>
    <feature>
      <name>OCR Screenshot Text Extraction</name>
      <description>Implement grim/slurp + tesseract pipeline for extracting text from screen regions. River keybinding captures area, performs OCR, and copies recognized text to clipboard.</description>
    </feature>
  </implemented_features>

  <additional_requirements>
    <requirement>x86_64-linux architecture required</requirement>
    <requirement>AMD GPU with Phoenix1 APU for primary display</requirement>
    <requirement>NVIDIA RTX 2000 Ada GPU for PRIME offload compute</requirement>
    <requirement>ED25519 SSH key at ~/.ssh/id_ed25519 for agenix secret decryption</requirement>
    <requirement>External monitors: Support for 3440x1440 ultrawide and 2560x1440 portrait displays</requirement>
    <requirement>Minimum 30 days of NixOS generations retained for rollback capability</requirement>
    <requirement>Steam and gaming dependencies require 32-bit graphics libraries</requirement>
    <requirement>Bluetooth audio requires experimental kernel features enabled</requirement>
  </additional_requirements>

  <development_guidelines>
    <guideline>Use flake-based configuration for reproducibility - all dependencies pinned via flake.lock</guideline>
    <guideline>Organize modules by domain: system modules in modules/system/, home modules in modules/home/</guideline>
    <guideline>Follow NixOS module pattern with imports, options, and config sections</guideline>
    <guideline>Use Stylix for theming - don&apos;t hardcode colors, let base16 propagate</guideline>
    <guideline>Prefer systemd user services for autostart applications over River spawn for restart resilience</guideline>
    <guideline>Keep secrets encrypted with agenix - never commit plaintext credentials</guideline>
    <guideline>Test configuration changes with &apos;nixos-rebuild build&apos; before &apos;nixos-rebuild switch&apos;</guideline>
    <guideline>Use treefmt for consistent code formatting across Nix, shell, and other files</guideline>
    <guideline>Document module purposes in comments at the top of each file</guideline>
    <guideline>Maintain security hardening - don&apos;t disable kernel or network protections without justification</guideline>
    <guideline>Use binary caches (nixos, ghostty, nix-community) for faster builds</guideline>
    <guideline>Keep state version pinned - update only during major migrations</guideline>
  </development_guidelines>

  <implementation_roadmap>
    <phase>
      <name>Core System Configuration</name>
      <status>completed</status>
      <description>Flake setup, host configuration, bootloader, networking, audio, graphics with hybrid GPU support</description>
    </phase>
    <phase>
      <name>Desktop Environment</name>
      <status>completed</status>
      <description>River WM with wideriver layouts, Kanshi display management, Ghostty terminal, unified Ayu Dark theming via Stylix</description>
    </phase>
    <phase>
      <name>Security Hardening</name>
      <status>completed</status>
      <description>Kernel hardening, AppArmor, auditd, sudo restrictions, network security, PAM limits</description>
    </phase>
    <phase>
      <name>Development Environment</name>
      <status>completed</status>
      <description>Neovim IDE with nvf, multi-language LSP support, Git tooling, Docker/K8s, cloud CLIs, AI coding assistants</description>
    </phase>
    <phase>
      <name>Secrets Management</name>
      <status>completed</status>
      <description>Agenix integration with AWS credentials encryption and automatic decryption</description>
    </phase>
    <phase>
      <name>Impermanence (Ephemeral Root)</name>
      <status>pending</status>
      <description>Optional ephemeral root filesystem with persistent data directories for enhanced security and system cleanliness</description>
    </phase>
    <phase>
      <name>Disko Declarative Partitioning</name>
      <status>pending</status>
      <description>Declarative disk partitioning for automated system installation and recovery</description>
    </phase>
  </implementation_roadmap>
</project_specification>