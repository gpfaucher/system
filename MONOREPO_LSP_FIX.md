# Practical Implementation Guide: Fixing LSP for Monorepos

## Quick Summary

**Problem**: LSP doesn't work properly in monorepos (paddock-app) because it can't distinguish between workspace root and project root.

**Solution**: Add a smart `root_dir` function that prioritizes `tsconfig.json` over `package.json`.

**Time to Fix**: 5 minutes

---

## STEP 1: Understand Your Current Setup

Your neovim config is generated by home-manager and lives at:

```
/nix/store/p5a015wsc7xyq5kp51amrqrzbv0az0ms-init.lua
```

This file is **read-only** and regenerated when home-manager runs. You cannot edit it directly.

---

## STEP 2: Create Local Override File

Create a user-editable configuration override:

```bash
mkdir -p ~/.config/nvf
touch ~/.config/nvf/monorepo-lsp.lua
```

---

## STEP 3: Add Monorepo-Aware LSP Configuration

Edit `~/.config/nvf/monorepo-lsp.lua`:

```lua
-- Monorepo LSP Configuration Override
-- This file enhances the default ts_ls configuration for monorepo support

-- Store original config
local original_ts_ls = vim.lsp.config["ts_ls"]

-- Enhanced root_dir function for monorepos
local function monorepo_root_dir(bufnr, on_dir)
  local fname = vim.api.nvim_buf_get_name(bufnr)

  -- Priority 1: Find closest tsconfig.json (most specific)
  -- This ensures that in monorepos, we use the project's tsconfig, not the root one
  local root = vim.fs.root(fname, 'tsconfig.json')
  if root then
    on_dir(root)
    return
  end

  -- Priority 2: Find jsconfig.json (for JavaScript-only projects)
  root = vim.fs.root(fname, 'jsconfig.json')
  if root then
    on_dir(root)
    return
  end

  -- Priority 3: package.json (workspace root)
  root = vim.fs.root(fname, 'package.json')
  if root then
    on_dir(root)
    return
  end

  -- Priority 4: .git root (emergency fallback)
  root = vim.fs.root(fname, '.git')
  if root then
    on_dir(root)
    return
  end

  -- No root found, use current directory
  on_dir(vim.fn.getcwd())
end

-- Override the ts_ls configuration with enhanced root detection
if original_ts_ls then
  original_ts_ls.root_dir = monorepo_root_dir
else
  -- If ts_ls isn't configured, create a new config
  vim.lsp.config["ts_ls"] = {
    cmd = { "typescript-language-server", "--stdio" },
    root_dir = monorepo_root_dir,
    filetypes = {
      "javascript",
      "javascriptreact",
      "typescript",
      "typescriptreact",
      "typescript.tsx",
      "typescript.jsx"
    }
  }
end

-- Optional: Add a debug function to check which root LSP detected
vim.api.nvim_create_user_command('LspDebugRoot', function()
  local fname = vim.api.nvim_buf_get_name(0)
  local roots = {}

  for marker in ("tsconfig.json:jsconfig.json:package.json:.git"):gmatch("[^:]+") do
    local root = vim.fs.root(fname, marker)
    if root then
      table.insert(roots, marker .. " -> " .. root)
    end
  end

  print("LSP Root Detection Debug:")
  if #roots > 0 then
    for _, info in ipairs(roots) do
      print("  " .. info)
    end
  else
    print("  No root markers found!")
  end

  -- Show current LSP
  local clients = vim.lsp.get_clients({ bufnr = 0 })
  if #clients > 0 then
    print("\nActive LSP Clients:")
    for _, client in ipairs(clients) do
      print("  - " .. client.name .. " (root: " .. (client.config.root_dir or "unknown") .. ")")
    end
  else
    print("\nNo LSP clients active for this buffer")
  end
end, {})

print("[LSP] Monorepo configuration loaded")
```

---

## STEP 4: Load the Override File

Add this to the generated init.lua. Since you can't edit it directly, create a hook:

**Option A: Modify Home-Manager Config (Permanent)**

Find your home-manager configuration (likely `~/.config/nixpkgs/home.nix` or part of your system flake) and add:

```nix
programs.neovim = {
  # ... existing config ...

  extraConfigLua = ''
    -- Load monorepo LSP configuration
    pcall(require, 'monorepo-lsp')
  '';
};
```

Then rebuild: `home-manager switch`

**Option B: Manual Loading (Temporary, for Testing)**

Create `~/.config/nvf/init-override.lua`:

```lua
-- This file is sourced at the very end of init.lua
-- It allows user customizations without modifying the generated config

-- Load monorepo LSP configuration
pcall(function()
  require('monorepo-lsp')
end)

-- Any other custom configs can go here
```

Then add to your generated init.lua (at the very end, after line 1472):

```lua
-- Load user overrides
pcall(function()
  dofile(vim.fn.expand('~/.config/nvf/init-override.lua'))
end)
```

---

## STEP 5: Test the Configuration

### Test 1: Open a File in the Monorepo

```bash
nvim ~/projects/paddock-app/apps/ui/app.tsx
```

### Test 2: Check LSP Status

Inside neovim, run:

```vim
:LspInfo
```

**Expected Output** (Look for this):

- LSP should attach to `ts_ls`
- Root directory should show `...paddock-app/apps/ui` NOT `...paddock-app`
- You should see `typescript` and `javascript` in supported filetypes

### Test 3: Use the Debug Command

Run the debug command we created:

```vim
:LspDebugRoot
```

**Expected Output**:

```
LSP Root Detection Debug:
  tsconfig.json -> /home/gabriel/projects/paddock-app/apps/ui
  package.json -> /home/gabriel/projects/paddock-app/apps/ui
  .git -> /home/gabriel/projects/paddock-app

Active LSP Clients:
  - ts_ls (root: /home/gabriel/projects/paddock-app/apps/ui)
```

Notice that `tsconfig.json` is found FIRST (at apps/ui level), which is correct!

### Test 4: Verify Completion Works

Try these:

- Type `const x = ` and press Ctrl-X Ctrl-O (or your completion keybind)
- Completion should work with proper project context
- Hover over imports with `K` key
- Run `:LspInfo` and check "Server capabilities"

---

## STEP 6: Test Each Monorepo Project

### Test paddock-app/apps/ui (React/Next.js)

```bash
nvim ~/projects/paddock-app/apps/ui/app.tsx
```

Expected: LSP uses `apps/ui/tsconfig.json`

### Test paddock-app/functions/linear-notification-lambda (TypeScript)

```bash
nvim ~/projects/paddock-app/functions/linear-notification-lambda/src/index.ts
```

Expected: LSP uses that directory's tsconfig.json or package.json

### Test at Workspace Root

```bash
cd ~/projects/paddock-app
nvim package.json
```

Expected: LSP still works, uses workspace package.json

---

## STEP 7: Advanced: Per-Project Configuration

For more sophisticated monorepo management, create project-specific configs:

### Create `.neorc.lua` in paddock-app/apps/ui/

```lua
-- .neorc.lua for paddock-app/apps/ui
return {
  -- Project-specific LSP settings
  lsp = {
    ts_ls = {
      -- Override settings for this specific project
      settings = {
        typescript = {
          inlayHints = {
            includeInlayParameterNameHints = "all",
            includeInlayParameterNameHintsWhenArgumentMatchesName = true,
            includeInlayFunctionLikeReturnTypeHints = true,
            includeInlayEnumMemberValueHints = true,
          }
        }
      }
    }
  }
}
```

Then load it in your LSP setup:

```lua
-- In monorepo-lsp.lua
local function load_project_config()
  local fname = vim.api.nvim_buf_get_name(0)
  local neorc_path = vim.fs.root(fname, '.neorc.lua')

  if neorc_path and vim.fn.filereadable(neorc_path .. '/.neorc.lua') == 1 then
    local config = dofile(neorc_path .. '/.neorc.lua')
    if config and config.lsp then
      return config.lsp
    end
  end

  return {}
end

-- Apply when LSP attaches
vim.api.nvim_create_autocmd('LspAttach', {
  group = vim.api.nvim_create_augroup('MonorepoLspAttach', { clear = true }),
  callback = function(args)
    local config = load_project_config()
    -- Apply project config...
  end
})
```

---

## STEP 8: Workspace Folders Setup (Optional Advanced)

For even better monorepo support, configure workspace folders:

```lua
-- Add to monorepo-lsp.lua

local function setup_workspace_folders()
  local root = vim.fs.root(vim.fn.getcwd(), '.git')
  if not root then return end

  -- Define workspace folders
  local workspaces = {
    { path = root .. '/apps/ui', name = 'paddock-ui' },
    { path = root .. '/apps/api', name = 'paddock-api' },
    { path = root .. '/functions/linear-notification-lambda', name = 'linear-lambda' },
  }

  -- Only set up if we detect we're in paddock-app
  if root:match('paddock%-app') then
    for _, workspace in ipairs(workspaces) do
      if vim.fn.isdirectory(workspace.path) == 1 then
        vim.lsp.buf.add_workspace_folder(workspace)
      end
    end
  end
end

-- Call on VimEnter or when opening files
vim.api.nvim_create_autocmd('VimEnter', {
  once = true,
  callback = setup_workspace_folders
})
```

---

## Troubleshooting

### Issue: LSP still using wrong root

**Check**:

1. Verify `.config/nvf/monorepo-lsp.lua` exists
2. Confirm it's loaded: `:messages` should show "[LSP] Monorepo configuration loaded"
3. Run `:LspDebugRoot` to see detected roots

**Solution**:

- Restart neovim: `:qa!` then `nvim`
- Manually reload: `:luafile ~/.config/nvf/monorepo-lsp.lua`

### Issue: LSP not attaching to TypeScript files

**Check**:

1. Run `:LspInfo` to see if ts_ls is registered
2. Check if file type is recognized: `:set filetype?`
3. Verify tsconfig.json exists in the project

**Solution**:

- Ensure tsconfig.json is at project root: `ls apps/ui/tsconfig.json`
- Check ts_ls is installed: `which typescript-language-server`
- Restart LSP: `:LspRestart ts_ls`

### Issue: Performance issues with large monorepos

**Solution**:

1. Exclude directories from LSP indexing:

```lua
settings = {
  typescript = {
    tsserver = {
      maxFileSize = 2500000,
      -- Exclude node_modules from search
    }
  }
}
```

2. Use workspace folders instead of single root
3. Consider using separate LSP instances per workspace

---

## Verification Checklist

- [ ] Created `~/.config/nvf/monorepo-lsp.lua`
- [ ] File loads without errors (check `:messages`)
- [ ] `:LspDebugRoot` shows correct priority
- [ ] Opening `paddock-app/apps/ui/` files uses `apps/ui/tsconfig.json`
- [ ] TypeScript completion works in each project
- [ ] No errors in `:LspLog`
- [ ] Performance is acceptable

---

## Next Steps

1. **Immediate**: Test the monorepo-lsp.lua override (5 min)
2. **Short-term**: Verify each project works (10 min)
3. **Optional**: Add workspace folders for better experience (20 min)
4. **Long-term**: Consider contributing improvements to home-manager nvf module

---

## Files Changed

```
~/.config/nvf/monorepo-lsp.lua      â† Create this
~/.config/nvf/init-override.lua     â† Create this (if using manual loading)
~/.config/nvf/                      â† May exist, or create if needed
```

## Testing Commands Quick Reference

```vim
" Open monorepo file
:edit ~/projects/paddock-app/apps/ui/app.tsx

" Check LSP status
:LspInfo

" Debug root detection
:LspDebugRoot

" Check log messages
:LspLog

" Restart LSP
:LspRestart ts_ls

" Force reload config
:luafile ~/.config/nvf/monorepo-lsp.lua
```

---

## Summary

The fix works by:

1. **Detecting priority**: tsconfig.json > jsconfig.json > package.json > .git
2. **Using vim.fs.root()**: Built-in Neovim function that finds markers upward
3. **Smart selection**: Prioritizes project-specific config over workspace root
4. **Monorepo aware**: Each app/function gets its own LSP root

Result: LSP works correctly in multi-workspace monorepos! ðŸŽ‰
